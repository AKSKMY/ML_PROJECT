<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Model Insights & Controls</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .visualization-card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .metric-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            transition: transform 0.3s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
        }
        .chart-container {
            position: relative;
            height: auto;
            width: 100%;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner-container {
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <a class="navbar-brand">üèçÔ∏è Motorcycle Price Prediction | Admin Panel</a>
        <form action="/logout" method="post">
            <button class="btn btn-warning">Logout</button>
        </form>
    </nav>

    <div class="container-fluid">
        <div class="row mt-4">
            <!-- Sidebar / Control Panel -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Model Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" id="model-status-alert">
                            Loading model information...
                        </div>

                        <!-- Model Selection Form -->
                        <form action="/update_model" method="post">
                            <label for="model">Active ML Model:</label>
                            <select id="model" name="model" class="form-control mb-3">
                                <!-- Options populated dynamically -->
                            </select>
                            <button type="submit" class="btn btn-primary btn-block">Update Model</button>
                        </form>
                        
                        <hr>
                        
                        <!-- User Filters Form -->
                        <h5 class="mt-3">User Interface Controls</h5>
                        <form action="/admin" method="post">
                            <h6>Active User Filters:</h6>
                            <div class="custom-control custom-switch mb-2">
                                <input type="checkbox" class="custom-control-input" id="license_class_switch" name="license_class" {% if filters.license_class %}checked{% endif %}>
                                <label class="custom-control-label" for="license_class_switch">License Class</label>
                            </div>
                            <div class="custom-control custom-switch mb-2">
                                <input type="checkbox" class="custom-control-input" id="mileage_range_switch" name="mileage_range" {% if filters.mileage_range %}checked{% endif %}>
                                <label class="custom-control-label" for="mileage_range_switch">Mileage Range</label>
                            </div>
                            <div class="custom-control custom-switch mb-2">
                                <input type="checkbox" class="custom-control-input" id="coe_left_range_switch" name="coe_left_range" {% if filters.coe_left_range %}checked{% endif %}>
                                <label class="custom-control-label" for="coe_left_range_switch">COE Left Range</label>
                            </div>
                            <div class="custom-control custom-switch mb-2">
                                <input type="checkbox" class="custom-control-input" id="previous_owners_switch" name="previous_owners" {% if filters.previous_owners %}checked{% endif %}>
                                <label class="custom-control-label" for="previous_owners_switch">Number of Previous Owners</label>
                            </div>
                            <button type="submit" class="btn btn-success btn-block mt-3">Save Settings</button>
                        </form>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="card mt-3">
                    <div class="card-header bg-secondary text-white">
                        <h5>System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>System Load:</span>
                            <span class="badge badge-success" id="system-load">Low</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Predictions:</span>
                            <span class="badge badge-primary" id="prediction-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Last Retrained:</span>
                            <span class="badge badge-info" id="last-retrained">Never</span>
                        </div>
                        <button class="btn btn-outline-primary btn-sm btn-block mt-3" id="refresh-stats-btn">
                            <i class="fas fa-sync-alt"></i> Refresh Stats
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Main Content / Visualizations -->
            <div class="col-md-9">
                <!-- Performance Metrics Row -->
                <div class="row">
                    <div class="col-12">
                        <h3>Model Performance Metrics</h3>
                        <p class="text-muted">Overview of the currently selected model's performance on test data</p>
                    </div>
                    <!-- Metric Cards -->
                    <div class="col-md-3">
                        <div class="metric-card bg-light">
                            <div class="metric-value text-primary" id="mae-value">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <div class="metric-label">Mean Absolute Error</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-light">
                            <div class="metric-value text-danger" id="rmse-value">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <div class="metric-label">Root Mean Squared Error</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-light">
                            <div class="metric-value text-success" id="r2-value">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <div class="metric-label">R¬≤ Score</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-light">
                            <div class="metric-value text-info" id="accuracy-value">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <div class="metric-label">Prediction Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <!-- Visualization Tabs -->
                <ul class="nav nav-tabs mt-4" id="visualizationTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab">
                            Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="comparison-tab" data-toggle="tab" href="#comparison" role="tab">
                            Model Comparison
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="features-tab" data-toggle="tab" href="#features" role="tab">
                            Feature Analysis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="market-tab" data-toggle="tab" href="#market" role="tab">
                            Market Trends
                        </a>
                    </li>
                </ul>
                
                <!-- Visualization Tab Content -->
                <div class="tab-content" id="visualizationTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row mt-3">
                            <!-- Actual vs Predicted Plot -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Actual vs Predicted Prices</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" id="actual-vs-predicted-container">
                                            <canvas id="actualVsPredictedChart"></canvas>
                                            <div class="loading-overlay" id="actual-vs-predicted-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Error Distribution -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Error Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" id="error-distribution-container">
                                            <canvas id="errorDistributionChart"></canvas>
                                            <div class="loading-overlay" id="error-distribution-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Residual Plot -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Residual Analysis</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="residualPlotChart"></canvas>
                                            <div class="loading-overlay" id="residual-plot-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Price Range Distribution -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Price Range Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="priceDistributionChart"></canvas>
                                            <div class="loading-overlay" id="price-distribution-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Model Comparison Tab -->
                    <div class="tab-pane fade" id="comparison" role="tabpanel">
                        <div class="row mt-3">
                            <!-- MAE Comparison -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>MAE Comparison</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="maeComparisonChart"></canvas>
                                            <div class="loading-overlay" id="mae-comparison-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RMSE Comparison -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>RMSE Comparison</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="rmseComparisonChart"></canvas>
                                            <div class="loading-overlay" id="rmse-comparison-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- R2 Comparison -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>R¬≤ Score Comparison</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="r2ComparisonChart"></canvas>
                                            <div class="loading-overlay" id="r2-comparison-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Training Time Comparison -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Training Time Comparison</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="trainingTimeChart"></canvas>
                                            <div class="loading-overlay" id="training-time-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Feature Analysis Tab -->
                    <div class="tab-pane fade" id="features" role="tabpanel">
                        <div class="row mt-3">
                            <!-- Feature Importance (for applicable models) -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Feature Importance</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="featureImportanceChart"></canvas>
                                            <div class="loading-overlay" id="feature-importance-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text-muted mt-2">
                                            <small>*Note: Feature importance may not be directly available for SVM models</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Correlation Matrix -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Feature Correlation</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="correlationChart"></canvas>
                                            <div class="loading-overlay" id="correlation-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Engine Size vs Price -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Engine Size vs Price</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="engineSizePriceChart"></canvas>
                                            <div class="loading-overlay" id="engine-size-price-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mileage vs Price -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Mileage vs Price</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="mileagePriceChart"></canvas>
                                            <div class="loading-overlay" id="mileage-price-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Market Trends Tab -->
                    <div class="tab-pane fade" id="market" role="tabpanel">
                        <div class="row mt-3">
                            <!-- COE Price Trend -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>COE Price Trend</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="coeTrendChart"></canvas>
                                            <div class="loading-overlay" id="coe-trend-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Price Trend by Brand -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Price by Brand</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="priceByBrandChart"></canvas>
                                            <div class="loading-overlay" id="price-by-brand-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Price Trend by Year -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>Price Trend by Year</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="priceTrendChart"></canvas>
                                            <div class="loading-overlay" id="price-trend-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- COE Effect on Used Market -->
                            <div class="col-md-6">
                                <div class="card visualization-card">
                                    <div class="card-header">
                                        <h5>COE Effect on Used Market</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="coeEffectChart"></canvas>
                                            <div class="loading-overlay" id="coe-effect-loading">
                                                <div class="spinner-container">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        // Global chart references to update them
        const charts = {};
        
        // Color scheme for charts
        const colors = {
            blue: 'rgba(54, 162, 235, 0.7)',
            blueLight: 'rgba(54, 162, 235, 0.3)',
            red: 'rgba(255, 99, 132, 0.7)',
            redLight: 'rgba(255, 99, 132, 0.3)',
            green: 'rgba(75, 192, 192, 0.7)',
            greenLight: 'rgba(75, 192, 192, 0.3)',
            orange: 'rgba(255, 159, 64, 0.7)',
            orangeLight: 'rgba(255, 159, 64, 0.3)',
            purple: 'rgba(153, 102, 255, 0.7)',
            purpleLight: 'rgba(153, 102, 255, 0.3)'
        };
        
        // Load model status
        function loadModelStatus() {
            $.get("/model_status", function(data) {
                let availableModels = data.available_models || [];
                let selectedModel = data.selected_model || "";

                $("#model").empty();

                if (availableModels.length > 0) {
                    availableModels.forEach(function(model) {
                        let option = $("<option></option>")
                            .attr("value", model)
                            .text(model === "svm" ? "Support Vector Machine" : 
                                 (model === "random_forest" ? "Random Forest" : 
                                 (model === "lightgbm" ? "LightGBM" : 
                                 (model === "xgboost" ? "XGBoost" : model))));

                        if (model === selectedModel) {
                            option.attr("selected", "selected");
                        }

                        $("#model").append(option);
                    });

                    $("#model-status-alert")
                        .removeClass("alert-info alert-warning alert-danger")
                        .addClass("alert-success")
                        .text(`${availableModels.length} models available. Currently using: ${selectedModel}`);
                        
                    // Load real performance metrics
                    loadPerformanceMetrics(selectedModel);
                } else {
                    $("#model-status-alert")
                        .removeClass("alert-info alert-success")
                        .addClass("alert-danger")
                        .text("No ML models could be loaded. Please check the dependencies.");
                }
            })
            .fail(function() {
                $("#model-status-alert")
                    .removeClass("alert-info alert-success")
                    .addClass("alert-danger")
                    .text("Error loading model information. Please check server logs.");
            });
        }
        
        // Load system stats
        function loadSystemStats() {
            $.get("/api/system_stats", function(data) {
                $("#system-load").text(data.system_load || "Low");
                $("#prediction-count").text(data.prediction_count || "0");
                $("#last-retrained").text(data.last_retrained || "Never");
            })
            .fail(function() {
                console.error("Failed to load system stats");
            });
        }
        
        // Load real performance metrics from the server
        function loadPerformanceMetrics(model) {
            // Show loading state
            $("#mae-value, #rmse-value, #r2-value, #accuracy-value").html(
                '<div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">Loading...</span></div>'
            );
            
            // Load real metrics from the server
            $.get("/api/model_metrics", { model: model }, function(data) {
                if (data) {
                    // Update metric cards with real data
                    $("#mae-value").text(`$${data.mae ? data.mae.toFixed(2) : "N/A"}`);
                    $("#rmse-value").text(`$${data.rmse ? data.rmse.toFixed(2) : "N/A"}`);
                    $("#r2-value").text(`${data.r2 ? data.r2.toFixed(2) : "N/A"}`);
                    $("#accuracy-value").text(`${data.accuracy ? data.accuracy.toFixed(1) : "N/A"}%`);
                    
                    // Also update visualizations with actual data
                    loadActualVsPredicedPlot(model);
                    
                    // Load model comparison data
                    loadModelComparisonData();
                } else {
                    // Show N/A if data is not available
                    $("#mae-value, #rmse-value, #r2-value, #accuracy-value").text("N/A");
                }
            })
            .fail(function() {
                console.error("Failed to load model metrics");
                $("#mae-value, #rmse-value, #r2-value, #accuracy-value").text("Error");
            });
        }
        
        // Check if a visualization can be loaded from an image
        function tryLoadVisualizationImage(model, visualizationType, containerId, loadingId) {
            const filename = `${model}_${visualizationType}.png`;
            
            // Show loading
            $(`#${loadingId}`).show();
            
            // Try to load the image
            $.ajax({
                url: `/visualization/${filename}`,
                type: 'HEAD',
                success: function() {
                    // Image exists, display it
                    $(`#${containerId}`).html(
                        `<img src="/visualization/${filename}" class="img-fluid" alt="${visualizationType}">`
                    );
                    $(`#${loadingId}`).hide();
                },
                error: function() {
                    // Image doesn't exist, show fallback
                    $(`#${loadingId}`).hide();
                }
            });
        }
        
        // Load actual vs predicted plot
        function loadActualVsPredicedPlot(model) {
            // Try to load the plot from a server-generated image
            tryLoadVisualizationImage(model, "actual_vs_predicted", "actual-vs-predicted-container", "actual-vs-predicted-loading");
            tryLoadVisualizationImage(model, "error_distribution", "error-distribution-container", "error-distribution-loading");
            
            // Load real data from API for other charts
            $.get("/api/chart_data", function(data) {
                // Show real data on charts
                updateChartsWithRealData(data);
            })
            .fail(function() {
                console.error("Failed to load chart data");
                // Hide all loading indicators
                $(".loading-overlay").hide();
            });
        }
        
        // Load model comparison data from API
        function loadModelComparisonData() {
            $.get("/api/model_metrics", function(allModelsData) {
                if (allModelsData) {
                    // Prepare data for comparison charts
                    const modelNames = [];
                    const maeValues = [];
                    const rmseValues = [];
                    const r2Values = [];
                    
                    // Process data for each model
                    for (const model in allModelsData) {
                        const prettyName = model === "svm" ? "SVM" : 
                                          (model === "random_forest" ? "Random Forest" : 
                                          (model === "lightgbm" ? "LightGBM" : 
                                          (model === "xgboost" ? "XGBoost" : model)));
                        
                        modelNames.push(prettyName);
                        maeValues.push(allModelsData[model].mae || 0);
                        rmseValues.push(allModelsData[model].rmse || 0);
                        r2Values.push(allModelsData[model].r2 || 0);
                    }
                    
                    // Update comparison charts
                    updateModelComparisonCharts(modelNames, maeValues, rmseValues, r2Values);
                }
                
                // Hide comparison loading overlays
                $("#mae-comparison-loading, #rmse-comparison-loading, #r2-comparison-loading").hide();
            })
            .fail(function() {
                console.error("Failed to load model comparison data");
                // Hide comparison loading overlays
                $("#mae-comparison-loading, #rmse-comparison-loading, #r2-comparison-loading").hide();
            });
        }
        
        // Update charts with real data from API
        function updateChartsWithRealData(data) {
            // Update Engine Size vs Price chart with real data
            if (data.engine_price_data && data.engine_price_data.length > 0) {
                updateOrCreateScatterChart(
                    'engineSizePriceChart',
                    data.engine_price_data,
                    'Engine Capacity (cc)',
                    'Price (SGD)',
                    'Engine Size vs Price',
                    colors.blue
                );
                
                // Hide loading overlay
                $("#engine-size-price-loading").hide();
            }
            
            // Update Mileage vs Price chart with real data
            if (data.mileage_price_data && data.mileage_price_data.length > 0) {
                updateOrCreateScatterChart(
                    'mileagePriceChart',
                    data.mileage_price_data,
                    'Mileage (km)',
                    'Price (SGD)',
                    'Mileage vs Price',
                    colors.orange
                );
                
                // Hide loading overlay
                $("#mileage-price-loading").hide();
            }
            
            // Update Residual Plot with real data
            if (data.residual_plot_data && data.residual_plot_data.length > 0) {
                updateOrCreateScatterChart(
                    'residualPlotChart',
                    data.residual_plot_data,
                    'Predicted Price (SGD)',
                    'Residual (Actual - Predicted)',
                    'Residual Analysis',
                    colors.red
                );
                
                // Hide loading overlay
                $("#residual-plot-loading").hide();
            }
            
            // Update Price Distribution chart with real data
            if (data.price_distribution_data) {
                updateOrCreateBarChart(
                    'priceDistributionChart',
                    data.price_distribution_data.labels,
                    data.price_distribution_data.frequencies,
                    'Price Range (SGD)',
                    'Frequency',
                    'Price Distribution',
                    colors.green
                );
                
                // Hide loading overlay
                $("#price-distribution-loading").hide();
            }
            
            // Update COE Trend chart with real data
            if (data.coe_trend_data) {
                updateOrCreateLineChart(
                    'coeTrendChart',
                    data.coe_trend_data.labels,
                    [
                        {
                            label: '2024 COE Prices',
                            data: data.coe_trend_data.year_2024,
                            backgroundColor: colors.blueLight,
                            borderColor: colors.blue,
                            fill: true
                        },
                        {
                            label: '2023 COE Prices',
                            data: data.coe_trend_data.year_2023,
                            backgroundColor: colors.redLight,
                            borderColor: colors.red,
                            fill: true
                        }
                    ],
                    'Month',
                    'COE Price (SGD)',
                    'Monthly COE Price Trends'
                );
                
                // Hide loading overlay
                $("#coe-trend-loading").hide();
            }
            
            // Update COE Effect chart with real data
            if (data.coe_used_market_data && data.coe_used_market_data.length > 0) {
                updateOrCreateScatterChart(
                    'coeEffectChart',
                    data.coe_used_market_data,
                    'COE Price (SGD)',
                    'Used Motorcycle Price (SGD)',
                    'Correlation: COE Prices vs Used Motorcycle Prices',
                    colors.purple
                );
                
                // Hide loading overlay
                $("#coe-effect-loading").hide();
            }
            
            // Update Price by Brand chart with real data
            if (data.price_by_brand_data && data.price_by_brand_data.length > 0) {
                const labels = data.price_by_brand_data.map(item => item.brand);
                const values = data.price_by_brand_data.map(item => item.avg_price);
                
                updateOrCreateBarChart(
                    'priceByBrandChart',
                    labels,
                    values,
                    'Brand',
                    'Average Price (SGD)',
                    'Average Price by Brand',
                    [colors.red, colors.blue, colors.green, colors.purple, colors.orange]
                );
                
                // Hide loading overlay
                $("#price-by-brand-loading").hide();
            }
            
            // Update Price Trend chart with real data
            if (data.price_trend_data) {
                updateOrCreateLineChart(
                    'priceTrendChart',
                    data.price_trend_data.labels,
                    [
                        {
                            label: 'Average Resale Price (SGD)',
                            data: data.price_trend_data.avg_resale_price,
                            borderColor: colors.blue,
                            fill: false
                        }
                    ],
                    'Year',
                    'Average Price (SGD)',
                    'Historical Price Trend'
                );
                
                // Hide loading overlay
                $("#price-trend-loading").hide();
            }
            
            // Update Feature Importance chart with real data
            if (data.feature_importance_data && data.feature_importance_data.length > 0) {
                const labels = data.feature_importance_data.map(item => item.feature);
                const values = data.feature_importance_data.map(item => item.importance);
                
                updateOrCreateBarChart(
                    'featureImportanceChart',
                    labels,
                    values,
                    'Feature',
                    'Importance',
                    'Feature Importance',
                    [colors.blue, colors.orange, colors.green, colors.red, colors.purple]
                );
                
                // Hide loading overlay
                $("#feature-importance-loading").hide();
            }
            
            // Update Feature Correlation chart with real data
            if (data.feature_correlation_data && data.feature_correlation_data.length > 0) {
                const labels = data.feature_correlation_data.map(item => item.feature);
                const values = data.feature_correlation_data.map(item => item.correlation);
                
                updateOrCreateBarChart(
                    'correlationChart',
                    labels,
                    values,
                    'Feature',
                    'Correlation Coefficient',
                    'Feature Correlation with Price',
                    [colors.blue, colors.orange, colors.green, colors.red, colors.purple],
                    {
                        y: {
                            min: -1,
                            max: 1
                        }
                    }
                );
                
                // Hide loading overlay
                $("#correlation-loading").hide();
            }
        }
        
        // Update model comparison charts
        function updateModelComparisonCharts(modelNames, maeValues, rmseValues, r2Values) {
            // Prepare colors for each model
            const modelColors = [colors.blue, colors.green, colors.orange, colors.purple];
            
            // Update MAE Comparison chart
            updateOrCreateBarChart(
                'maeComparisonChart',
                modelNames,
                maeValues,
                'Model',
                'Mean Absolute Error ($)',
                'MAE Comparison (Lower is Better)',
                modelColors,
                {
                    indexAxis: 'y'
                }
            );
            
            // Update RMSE Comparison chart
            updateOrCreateBarChart(
                'rmseComparisonChart',
                modelNames,
                rmseValues,
                'Model',
                'Root Mean Squared Error ($)',
                'RMSE Comparison (Lower is Better)',
                modelColors,
                {
                    indexAxis: 'y'
                }
            );
            
            // Update R2 Comparison chart
            updateOrCreateBarChart(
                'r2ComparisonChart',
                modelNames,
                r2Values,
                'Model',
                'R¬≤ Score',
                'R¬≤ Score Comparison (Higher is Better)',
                modelColors,
                {
                    y: {
                        min: Math.max(0, Math.min(...r2Values) - 0.1),
                        max: Math.min(1.0, Math.max(...r2Values) + 0.1)
                    }
                }
            );
            
            // Add placeholder for training time
            const trainingTimes = [12.5, 4.3, 8.1, 6.9]; // Replace with real data when available
            
            updateOrCreateBarChart(
                'trainingTimeChart',
                modelNames,
                trainingTimes,
                'Model',
                'Training Time (seconds)',
                'Training Time Comparison',
                modelColors
            );
            
            // Hide training time loading
            $("#training-time-loading").hide();
        }
        
        // Helper function to update or create a scatter chart
        function updateOrCreateScatterChart(canvasId, data, xLabel, yLabel, title, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                // Update existing chart
                charts[canvasId].data.datasets[0].data = data;
                charts[canvasId].options.scales.x.title.text = xLabel;
                charts[canvasId].options.scales.y.title.text = yLabel;
                charts[canvasId].options.plugins.title.text = title;
                charts[canvasId].update();
            } else {
                // Create new chart
                charts[canvasId] = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: title,
                            data: data,
                            backgroundColor: color
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: xLabel
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: yLabel
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: title
                            }
                        }
                    }
                });
            }
        }
        
        // Helper function to update or create a bar chart
        function updateOrCreateBarChart(canvasId, labels, data, xLabel, yLabel, title, backgroundColor, additionalScaleOptions = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                // Update existing chart
                charts[canvasId].data.labels = labels;
                charts[canvasId].data.datasets[0].data = data;
                charts[canvasId].data.datasets[0].backgroundColor = backgroundColor;
                charts[canvasId].options.scales.x.title.text = xLabel;
                charts[canvasId].options.scales.y.title.text = yLabel;
                charts[canvasId].options.plugins.title.text = title;
                
                // Apply additional scale options
                if (additionalScaleOptions.indexAxis) {
                    charts[canvasId].options.indexAxis = additionalScaleOptions.indexAxis;
                }
                if (additionalScaleOptions.y) {
                    charts[canvasId].options.scales.y = {
                        ...charts[canvasId].options.scales.y,
                        ...additionalScaleOptions.y
                    };
                }
                
                charts[canvasId].update();
            } else {
                // Create scale options
                const scaleOptions = {
                    x: {
                        title: {
                            display: true,
                            text: xLabel
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yLabel
                        }
                    }
                };
                
                // Apply additional scale options
                if (additionalScaleOptions.y) {
                    scaleOptions.y = {
                        ...scaleOptions.y,
                        ...additionalScaleOptions.y
                    };
                }
                
                // Create new chart
                charts[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title,
                            data: data,
                            backgroundColor: backgroundColor
                        }]
                    },
                    options: {
                        indexAxis: additionalScaleOptions.indexAxis || 'x',
                        scales: scaleOptions,
                        plugins: {
                            title: {
                                display: true,
                                text: title
                            }
                        }
                    }
                });
            }
        }
        
        // Helper function to update or create a line chart
        function updateOrCreateLineChart(canvasId, labels, datasets, xLabel, yLabel, title) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                // Update existing chart
                charts[canvasId].data.labels = labels;
                charts[canvasId].data.datasets = datasets;
                charts[canvasId].options.scales.x.title.text = xLabel;
                charts[canvasId].options.scales.y.title.text = yLabel;
                charts[canvasId].options.plugins.title.text = title;
                charts[canvasId].update();
            } else {
                // Create new chart
                charts[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: xLabel
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: yLabel
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: title
                            }
                        }
                    }
                });
            }
        }
        
        // Generate random scatter data (only used as fallback)
        function generateScatterData(count, minX, maxX, minY, maxY) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push({
                    x: minX + (Math.random() * (maxX - minX)),
                    y: minY + (Math.random() * (maxY - minY))
                });
            }
            return data;
        }
        
        // On page load, load model status, system stats and visualizations
        loadModelStatus();
        loadSystemStats();
        
        // When the model dropdown changes, update metrics and visualizations
        $("#model").change(function() {
            const selectedModel = $(this).val();
            loadPerformanceMetrics(selectedModel);
        });
        
        // When tabs are clicked, make sure charts are properly sized
        $('a[data-toggle="tab"]').on('shown.bs.tab', function() {
            // Resize all charts to fit containers
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.resize();
                }
            });
        });
        
        // Refresh stats button click handler
        $("#refresh-stats-btn").click(function() {
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
            
            // Refresh system stats and metrics
            loadSystemStats();
            loadPerformanceMetrics($("#model").val());
            
            // Reset button after 1 second
            setTimeout(() => {
                $(this).html('<i class="fas fa-sync-alt"></i> Refresh Stats');
            }, 1000);
        });
    });
</script>

</body>
</html>